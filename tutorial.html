<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200&family=Open+Sans&display=swap" rel="stylesheet">
    <title>Document</title>
</head>
<body>
    <div class="container">
        <div class="section">
            <h3>Download The Project Files</h3>
            <p>
                If you dont have github installed you can download the file as a zip from the github repo. 
                Otherwise clone <a href="https://github.com/FFreezer/InternetTechnologiesCoursework1" target="#">this project</a>
            </p>
        </div>

        <div class="section">
            <h3>Download Package Files</h3>
            <p>
                Navigate using your console to the project directory and <pre>run npm install</pre> 
            </p>
        </div>
        
        <div class="section">
            <h3>Database Connection Details</h3>
            <p>
                Once you've downloaded the project open your <pre>db_config.js</pre> file and modify it to use these values
                <br />
                <pre>const db_username = "tutorialuser";</pre> <br />
                <pre>const db_password = "7CQLhe6Bfx6tUCXC";</pre> <br />
                <pre>const db_database = "sample_supplies";</pre> <br />
            </p>
        </div>

        <div class="section">
            <h3>Test the application</h3>
            <p>
                Once you've modified the above values you should be able to run <pre>npm run dev</pre> and the application will 
                boot. You should see a message in your console saying <br /> <pre>MongoDB Connected <br />Application is listening on port 8080. Browse to http://localhost:8080/graphql</pre>
            </p>
            <p>
                Open your browser and navigate to <pre>localhost:8080/graphql</pre>. A window should load with a panel on the left
                and a panel on the right. 
                <br />
                In the left hand panel copy and paste the following.
                <br />
                <pre>
                    query {
                        getAllSales {
                          _id
                          saleDate
                          storeLocation
                          couponUsed
                          purchaseMethod
                          items {
                            name
                            tags
                            price
                            quantity
                          }
                          customer {
                            gender
                            age
                            email
                            satisfaction
                          }
                        }
                      }
                    </pre>
                <br>
                Hit the <pre>prettify</pre> button to format the text into something more readable.
                Now hit the play button in the middle of the screen. This query may take a little while to load as you're fetching <strong>every</strong>
                entry in the collection (/database).
                <br />
                Try removing purchaseMethod and the email from the customer. Now when you send your query you'll get everything except those fields as you've not requested them.
                <strong>Note that in this instance the server is filtering these items out for you however this can also be done through your MongoDB query meaning your server doesn't have to do the filtering as it's performed by your database.</strong>
            </p>
            <p>
                Now try changing the query to getSaleById. You'll need an ID to query the database with. Heres a random one <pre>5bd761dcae323e45a93ccff0</pre>.
                after the word getSaleById put round parentheses and press <pre>LCtrl & Space</pre>. It should auto fill the word <pre>id</pre>.
                Now if you put your ID in quotes after the letters <pre>id</pre> like this <pre>id:"5bd761dcae323e45a93ccff0"</pre> and hit search you should
                get back only that result.
            </p>

        </div>

        <div class="section">
            <h3>Task Specification</h3>
            <p>Create a new query that searches the database for a record based on the customers email address. You should only have to modify the files <pre>typeDefs.js & sales.js</pre></p>
            <p>Use the code that is already given to you to help you understand how to </p>
        </div>

        <div class="section">
            <h3>Modifying Your Type Definitions</h3>
            <p>First you're going to need to add the query we want to make to your list of queries. Do to this 
                go into your <pre>typeDefs.js</pre> file and modify the query type near the bottom.
                Add a new line that says 
                <pre>getSaleByCustomerEmail(email_in: String) : Sale</pre>
                This takes one argument of type String and will return one Sale object. You can look at what a Sale object is 
                by scrolling to the top of the file and looking at the <pre>type Sale</pre> definition.
            </p>

            <h3>Making our resolver</h3>
            <p>
                Create a new resolver by going into <pre>sales.js</pre> and underneath the <pre>getSaleById</pre> function make a new funciton with
                <pre>async function getSaleByCustomerEmail(parent, args, context, info){}</pre>
                First we need to get the arguments we've passed to the resolver, these are stored as key value pairs in our args argument.
                To access these we need to destructure the object. You can do this either in the function signature or in the body. We'll do it in the body.
                <pre>
                    getSaleByCusomterEmail(parent,args,context,info) {
                        const { email_in : email } = args;
                    }
                </pre>
                Now we can access the email address we pass into our query by accessing the email variable.

                We've got a Sale model thats built using Mongoose for MongoDB. These models come with powerful search functionality.
                We can use the model to query our database. Remember, GraphQL doesn't actually query your database, in this instance it sits in between your database driver and your application.
            </p>

            <h3>Querying Our Database</h3>
            <p>
                We can asynchronously query our database with Model.find() to get all results or  just Model.findOne() to get one result. We're going to use findOne here.
                Use 
                <pre>
                    try{
                        const { email : email } = args;
                        const sale = await Sale.findOne( { "customer.email" : email });
                        const sale_json = sale.toJSON();
                        return {
                            ...sale_json
                        }
                    }catch(err){
                        throw new Error(err);
                    }
                </pre>
                We're wrapping this in a try/catch block as theres a chance the query could fail for some reason.
                Our first line is destructuring our args argument passed into the function.
                The second line is sending an asynchronous query to our database. It is attempting to match the customer.email with our email query.
                <br />
                The third line is only required because we have an entry in the database stored as decimal128 which javascript doesn't natively support, so it is being converted into a string that we can read.
                You could parse this into a Number type if you wanted but here we are just using String.
                <br />
                We are then returning our sale_json object using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax" target="#"></a> syntax.
            </p>
        </div>

        <div class="section">
            <h3>Limiting Our Query</h3>
            <p>
                If you want to limit what the query can return then modify your type definitions.
                Say your database stores passwords but you never want them to be visible to the client, you could make a User type that ommits the password proprety, meaning the server will
                never return it to whichever client is making the query.
                <br />
                Go into your <pre>typeDefs.js</pre> file and comment out line 6, the one for saleDate.
                Hit save. Your application should restart itself if you haven't broken anything else. Now if you make a query GraphQL will throw an error, stating that it does not recognise the type saleDate.
                Remove saleDate from your query and hit send again and it should return everything but the saleDate.

            </p>
        </div>

    </div>
</body>
</html>